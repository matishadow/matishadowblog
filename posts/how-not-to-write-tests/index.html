<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Journey Writing no tests Nobody starts programming with writing tests right away. You always start with a Hello World followed by heaps of pretty bad and untestable code. (I still remember coding a Tic-tac-toe game by writing thousands of ifs for every possible move.)
 Let’s fantasize, things go different way. That after just one project everyone discovers the idea of unit testing. Just imagine everyone creates tests for every piece of code they write."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/how-not-to-write-tests/><title>How not to write tests - TDD in .NET :: Security and programming stuff — A simple theme for Hugo</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.e9b3dfcc5ffe9d55eb281ecaf47cf6179d26eec497e087299934d581c987aa0b.css><meta itemprop=name content="How not to write tests - TDD in .NET"><meta itemprop=description content="Journey Writing no tests Nobody starts programming with writing tests right away. You always start with a Hello World followed by heaps of pretty bad and untestable code. (I still remember coding a Tic-tac-toe game by writing thousands of ifs for every possible move.)
 Let’s fantasize, things go different way. That after just one project everyone discovers the idea of unit testing. Just imagine everyone creates tests for every piece of code they write."><meta itemprop=datePublished content="2021-01-28T00:00:00+00:00"><meta itemprop=dateModified content="2021-01-28T00:00:00+00:00"><meta itemprop=wordCount content="1264"><meta itemprop=image content="/"><meta itemprop=keywords content="programming,.net,tdd,unit-testing,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/"><meta name=twitter:title content="How not to write tests - TDD in .NET"><meta name=twitter:description content="Journey Writing no tests Nobody starts programming with writing tests right away. You always start with a Hello World followed by heaps of pretty bad and untestable code. (I still remember coding a Tic-tac-toe game by writing thousands of ifs for every possible move.)
 Let’s fantasize, things go different way. That after just one project everyone discovers the idea of unit testing. Just imagine everyone creates tests for every piece of code they write."><meta property="article:published_time" content="2021-01-28 00:00:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>matishadow's blog</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://majtkishadow-blog.gear.host/>Polish blog</a></li><li><a href=/posts>Posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>6 minutes</p></div><article><h1 class=post-title><a href=/posts/how-not-to-write-tests/>How not to write tests - TDD in .NET</a></h1><div class=post-content><div class=sect1><h2 id=_journey>Journey</h2><div class=sectionbody><div class=sect2><h3 id=_writing_no_tests>Writing no tests</h3><div class=paragraph><p>Nobody starts programming with writing tests right away.
You always start with a <code>Hello World</code> followed by heaps of pretty bad and untestable code.
(I still remember coding a <code>Tic-tac-toe</code> game by writing thousands of <code>ifs</code> for every possible move.)</p></div><div class=paragraph><p>Let’s fantasize, things go different way.
That after just one project everyone discovers the idea of unit testing.
Just imagine everyone creates tests for every piece of code they write.
The software shines, never breaks and nothing can go to
<a href=https://www.reddit.com/r/badcode>/r/badcode</a>.
Seems like a perfect world.</p></div><div class=paragraph><p>Unfortunately, just as with code, you can write good unit tests or bad unit tests.
With code, however, people <em>agree on the definition of good, with unit tests - not so much.</em></p></div></div><div class=sect2><h3 id=_writing_tests_with_everything_mocked>Writing tests with everything mocked</h3><div class=paragraph><p>During half a year of work in my previous company I used to write many tests.
Not only me but my whole team tried to write as many tests as possible.</p></div><div class=paragraph><p>Don’t get me wrong, these tests surely helped with spotting many nasty bugs, but most of them had one major issue in them.</p></div><div class=quoteblock><blockquote><div class=paragraph><p>I bet 10 monies that you cannot find the issue.</p></div></blockquote></div><div class=listingblock><div class=title>Example of an unit test I wrote in my previous job</div><div class=content><pre class=highlight><code class=language-csharp data-lang=csharp>using FederationGatewayApi.Services;
using FluentAssertions;
using Moq;
using NUnit.Framework;
using System;
using System.Security.Cryptography;
using System.Security.Cryptography.X509Certificates;

namespace DIGNDB.App.SmitteStop.Testing.ServiceTest.Gateway
{
    [TestFixture]
    public class GatewayKeyProviderTests
    {
        private readonly Mock&lt;IX509StoreWrapper&gt; _x509StoreWrapperMock = new Mock&lt;IX509StoreWrapper&gt;();
        private readonly Mock&lt;ISha256Wrapper&gt; _sha256WrapperMock = new Mock&lt;ISha256Wrapper&gt;();
        private readonly Mock&lt;IBitConverterWrapper&gt; _bitConverterWrapperMock = new Mock&lt;IBitConverterWrapper&gt;();
        private readonly Mock&lt;IPrivateKeyFactoryWrapper&gt; _privateKeyFactoryWrapperMock = new Mock&lt;IPrivateKeyFactoryWrapper&gt;();
        private readonly Mock&lt;IX509CertificateParserWrapper&gt; _x509CertificateParserWrapperMock = new Mock&lt;IX509CertificateParserWrapper&gt;();

        private const string AuthenticationCertificateFingerprint = &#34;A3C3E533CC9FEACA026F99F688F4488B5FC16BD0E6A80E6E0FC03760983DBF3F&#34;;
        private const string SigningCertificateFingerprint = &#34;979673B55DB0B7E2B35B12CF2A342655F059314BC46323C43BCD3BFC82374BFB&#34;;

        [Test]
        public void Should_Read_Certificates_From_UserStore_First_Then_Local_Machine()
        {
            int callOrder = 0;

            _x509StoreWrapperMock.Setup(mock =&gt; mock.Initialize(StoreName.My, StoreLocation.CurrentUser))
                .Callback(() =&gt;
                {
                    callOrder++;
                    callOrder.Should().Be(1);
                });
            _x509StoreWrapperMock.Setup(mock =&gt; mock.Initialize(StoreName.My, StoreLocation.LocalMachine))
                .Callback(() =&gt;
                {
                    callOrder++;
                    callOrder.Should().Be(2);
                });

            try
            {
                var gatewayKeyProvider = new GatewayKeyProvider(
                    AuthenticationCertificateFingerprint,
                    SigningCertificateFingerprint,
                    _x509StoreWrapperMock.Object,
                    _sha256WrapperMock.Object,
                    _bitConverterWrapperMock.Object,
                    _privateKeyFactoryWrapperMock.Object,
                    _x509CertificateParserWrapperMock.Object);
            }
            catch (AssertionException)
            {
                throw;
            }
            catch (CryptographicException)
            {
                throw;
            }
            catch (Exception e)
            {
                // ignored because testing only interaction with X509Store
            }
        }
    }
}</code></pre></div></div><div class=paragraph><p>You gave up? Good!
The problem emerges when we have everything mocked.
With everything mocked you basically have to write too much logic for the mocks.
The test definitely should not care about this logic.
It couples the test to the inner implementation details.
In other words it breaks encapsulation because it exposes classes, which usually you should hide.</p></div><div class=paragraph><p>Why is it so bad?
Well, many times when you refactor the code (change implementation details without changing the behavior) the tests break.
A change, as simple as adding another parameter to one implementation class,
could break many mocks and in result break many tests.</p></div><div class=paragraph><p>It happened to me so many times that I started wondering <em>am I doing something wrong?</em>.</p></div></div><div class=sect2><h3 id=_testing_in_a_bdd_style>Testing in a BDD style</h3><div class=paragraph><p>The general gist is to test only public API of a module and keep the implementation details private.
This strategy not only makes you focus on behaviours of your module (requirements),
but it also makes you write fewer tests.
Your tests will not break that often when they depend on the API because it should not change that often.</p></div><div class=paragraph><p>Ian Cooper explores this idea in the following video:</p></div><div class=videoblock><div class=content><iframe src="https://www.youtube.com/embed/EZ05e7EMOLM?rel=0" frameborder=0 allowfullscreen></iframe></div></div><div class=paragraph><p>He also recommends a book:
<a href=https://www.amazon.com/Test-Driven-Development-Kent-Beck/dp/0321146530><em>Test Driven Development: By Example</em> by Kent Beck</a>,
which also explains this idea in-depth.</p></div><div class=paragraph><p>Go watch Ian and read Kent’s book to understand the topic better.</p></div></div></div></div><div class=sect1><h2 id=_proof_of_concept_project>Proof of concept project</h2><div class=sectionbody><div class=paragraph><p>Now time for the example.</p></div><div class=paragraph><p>Firstly you need to decide, which classes represent the API and, which represent implementation details.
Mark API classes as <code>public</code> and for implementation classes use the <code>internal</code> keyword.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-csharp data-lang=csharp>using System;

namespace TestDrivenExample.ExampleModule.Internal
{
    internal class TemperatureArgumentValidator : ITemperatureArgumentValidator
    {
        public void ValidateCelsiusToKelvinArgument(double celsiusDegrees)
        {
            if (celsiusDegrees &lt; -273.15)
                throw new ArgumentException(&#34;Temperature cannot be below absolute zero.&#34;, nameof(celsiusDegrees));
        }
    }
}</code></pre></div></div><div class=paragraph><p>How to use those <code>internal</code> classes when using an <em>IoC container</em>?
Extension methods come to rescue.
Each module could expose an extension method for registering its internal classes to the container.
<code>AddExampleModule(this IServiceCollection services)</code> would add all the
classes for <code>ExampleModule</code> module.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-csharp data-lang=csharp>using Microsoft.Extensions.DependencyInjection;
using TestDrivenExample.ExampleModule.Internal;
using TestDrivenExample.ExampleModule.PublicClasses;

namespace TestDrivenExample.ExampleModule.Configuration
{
    public static class ServicesConfiguration
    {
        public static void AddExampleModule(this IServiceCollection services)
        {
            services.AddScoped&lt;ITemperatureConverter, TemperatureConverter&gt;();
            services.AddScoped&lt;IConversionRates, ConversionRates&gt;();
            services.AddScoped&lt;IDoubleAdder, DoubleAdder&gt;();
            services.AddScoped&lt;ITemperatureArgumentValidator, TemperatureArgumentValidator&gt;();
        }
    }
}</code></pre></div></div><div class=paragraph><p>By using an <em>IoC container</em> with the <code>internal</code> classes, they don’t get coupled to the
API classes (<code>TemperatureConverter</code> in this case.).</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-csharp data-lang=csharp>using TestDrivenExample.ExampleModule.Internal;
using TestDrivenExample.ExampleModule.PublicClasses;

namespace TestDrivenExample.ExampleModule
{
    public class TemperatureConverter : ITemperatureConverter
    {
        private readonly IDoubleAdder _doubleAdder;
        private readonly IConversionRates _conversionRates;
        private readonly ITemperatureArgumentValidator _temperatureArgumentValidator;

        public TemperatureConverter(
            IDoubleAdder doubleAdder,
            IConversionRates conversionRates,
            ITemperatureArgumentValidator temperatureArgumentValidator)
        {
            _doubleAdder = doubleAdder;
            _conversionRates = conversionRates;
            _temperatureArgumentValidator = temperatureArgumentValidator;
        }

        public double ConvertFromCelsiusToKelvin(double celsiusDegrees)
        {
            _temperatureArgumentValidator.ValidateCelsiusToKelvinArgument(celsiusDegrees);

            var conversionRate = _conversionRates.GetCelsiusToKelvinConversionRate();

            return _doubleAdder.Add(celsiusDegrees, conversionRate);
        }
    }
}</code></pre></div></div><div class=paragraph><p>You can later use this API class in any framework e.g., <code>.NET WebAPI</code>.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-csharp data-lang=csharp>using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using TestDrivenExample.ExampleModule.PublicClasses;

namespace TestDrivenExample.API.Controllers
{
    [ApiController]
    [Route(&#34;[controller]&#34;)]
    public class WeatherForecastController : ControllerBase
    {
        private readonly ITemperatureConverter _temperatureConverter;

        private static readonly string[] Summaries = new[]
        {
            &#34;Freezing&#34;, &#34;Bracing&#34;, &#34;Chilly&#34;, &#34;Cool&#34;, &#34;Mild&#34;, &#34;Warm&#34;, &#34;Balmy&#34;, &#34;Hot&#34;, &#34;Scorching&#34;
        };

        private readonly ILogger&lt;WeatherForecastController&gt; _logger;

        public WeatherForecastController(
            ILogger&lt;WeatherForecastController&gt; logger,
            ITemperatureConverter temperatureConverter)
        {
            _logger = logger;
            _temperatureConverter = temperatureConverter;
        }

        [HttpGet]
        public IEnumerable&lt;WeatherForecast&gt; Get()
        {
            var rng = new Random();
            return Enumerable.Range(1, 5).Select(index =&gt;
                {
                    int r = rng.Next(-20, 55);

                    return new WeatherForecast
                    {
                        Date = DateTime.Now.AddDays(index),
                        TemperatureC = r,
                        TemperatureKelvins = _temperatureConverter.ConvertFromCelsiusToKelvin(r),
                        Summary = Summaries[rng.Next(Summaries.Length)]
                    };
                })
                .ToArray();
        }
    }
}</code></pre></div></div><div class=paragraph><p>To register the module’s classes just call <code>services.AddExampleModule();</code> on the container object.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-csharp data-lang=csharp>using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.HttpsPolicy;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using Microsoft.OpenApi.Models;
using TestDrivenExample.ExampleModule.Configuration;

namespace TestDrivenExample.API
{
    public class Startup
    {
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        public IConfiguration Configuration { get; }

        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddControllers();
            services.AddSwaggerGen(c =&gt;
            {
                c.SwaggerDoc(&#34;v1&#34;, new OpenApiInfo {Title = &#34;TestDrivenExample.API&#34;, Version = &#34;v1&#34;});
            });

            services.AddExampleModule();
        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
                app.UseSwagger();
                app.UseSwaggerUI(c =&gt; c.SwaggerEndpoint(&#34;/swagger/v1/swagger.json&#34;, &#34;TestDrivenExample.API v1&#34;));
            }

            app.UseHttpsRedirection();

            app.UseRouting();

            app.UseAuthorization();

            app.UseEndpoints(endpoints =&gt; { endpoints.MapControllers(); });
        }
    }
}</code></pre></div></div><div class=paragraph><p>Lastly let’s look at the tests.
To test an API class from a module just call the extension method of the module:
<code>serviceCollection.AddExampleModule();</code> and then just ask the container to
initialize the class under test by calling <code>serviceProvider.GetService&lt;ITemperatureConverter>();</code>.</p></div><div class=paragraph><p>Some might say that interacting with an <em>IoC Container</em> is an overkill, but it has another benefit.
With the container, you don’t have to call the constructor in the test code so adding a new dependency via constructor injection won’t break the tests.</p></div><div class=paragraph><p>What about those internal classes?
How to test them if you marked them as <code>internal</code>?
You do not need to test them, the container will initialize them if needed, and the tests
of API classes will cover them by the way.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-csharp data-lang=csharp>using System;
using FluentAssertions;
using Microsoft.Extensions.DependencyInjection;
using NUnit.Framework;
using TestDrivenExample.ExampleModule.Configuration;
using TestDrivenExample.ExampleModule.PublicClasses;

namespace TestDrivenExample.Tests
{
    public class TemperatureConverterTests
    {
        private ITemperatureConverter _temperatureConverter;

        [SetUp]
        public void Setup()
        {
            var serviceCollection = new ServiceCollection();
            serviceCollection.AddExampleModule();

            ServiceProvider serviceProvider = serviceCollection.BuildServiceProvider();
            _temperatureConverter = serviceProvider.GetService&lt;ITemperatureConverter&gt;();
        }

        [TestCase(10, 283.15)]
        [TestCase(20, 293.15)]
        [TestCase(100, 373.15)]
        [TestCase(500, 773.15)]
        [TestCase(5000, 5273.15)]
        public void Should_Convert_Degrees_From_Celsius_To_Kelvin(double celsiusDegrees, double expectedResult)
        {
            var valueInKelvins = _temperatureConverter.ConvertFromCelsiusToKelvin(celsiusDegrees);

            valueInKelvins.Should().Be(expectedResult);
        }

        [TestCase(-273.16)]
        [TestCase(-373.15)]
        [TestCase(-1000)]
        public void Should_Throw_Argument_Exception_If_Input_Below_Absolute_Zero(double celsiusDegrees)
        {
            Action convertAction = () =&gt; _temperatureConverter.ConvertFromCelsiusToKelvin(celsiusDegrees);

            convertAction.Should().Throw&lt;ArgumentException&gt;();
        }
    }
}</code></pre></div></div><div class=sect2><h3 id=_repository_with_the_presented_code>Repository with the presented code</h3><div class=paragraph><p><a href=https://github.com/matishadow/TDD-.NET-Example class=bare>https://github.com/matishadow/TDD-.NET-Example</a></p></div></div></div></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=/tags/programming>programming</a></span><span class=tag><a href=/tags/.net>.net</a></span><span class=tag><a href=/tags/tdd>tdd</a></span><span class=tag><a href=/tags/unit-testing>unit-testing</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1264 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-01-28 00:00 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/hacking-buttons-p2/><span class=button__text>Hacking buttons - part 2</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//matishadow-blog.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span></span><span><a href=/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.766584e6ea536f54faf86b018d73f719fc520199a6c4d32cbd959eb87634c11b380ac646d80d67304313aac0f5f05e6715221bd99a619bbc905365b55f78147f.js integrity="sha512-dmWE5upTb1T6+GsBjXP3GfxSAZmmxNMsvZWeuHY0wRs4CsZG2A1nMEMTqsD18F5nFSIb2Zphm7yQU2W1X3gUfw=="></script></body></html>