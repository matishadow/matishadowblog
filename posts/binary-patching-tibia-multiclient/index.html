<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Childhood dreams During some of my first school years I used to play an MMORPG game. It had a reputation for having a lot of cheats for it. (Bad reputation still counts as reputation, right?)
 People have created all kinds of software for it. Some small and harmless programs enabled you to change the outfit of your character client-side. Others, much clever ones, made trees invisible, so you could see items hidden behind them."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/binary-patching-tibia-multiclient/><title>Binary patching - creating Tibia MultiClient :: Security and programming stuff — A simple theme for Hugo</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.e9b3dfcc5ffe9d55eb281ecaf47cf6179d26eec497e087299934d581c987aa0b.css><meta itemprop=name content="Binary patching - creating Tibia MultiClient"><meta itemprop=description content="Childhood dreams During some of my first school years I used to play an MMORPG game. It had a reputation for having a lot of cheats for it. (Bad reputation still counts as reputation, right?)
 People have created all kinds of software for it. Some small and harmless programs enabled you to change the outfit of your character client-side. Others, much clever ones, made trees invisible, so you could see items hidden behind them."><meta itemprop=datePublished content="2020-11-23T00:00:00+00:00"><meta itemprop=dateModified content="2020-11-23T00:00:00+00:00"><meta itemprop=wordCount content="873"><meta itemprop=image content="/"><meta itemprop=keywords content="re,patching,binary,reverse-engineering,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/"><meta name=twitter:title content="Binary patching - creating Tibia MultiClient"><meta name=twitter:description content="Childhood dreams During some of my first school years I used to play an MMORPG game. It had a reputation for having a lot of cheats for it. (Bad reputation still counts as reputation, right?)
 People have created all kinds of software for it. Some small and harmless programs enabled you to change the outfit of your character client-side. Others, much clever ones, made trees invisible, so you could see items hidden behind them."><meta property="article:published_time" content="2020-11-23 00:00:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>matishadow's blog</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://majtkishadow-blog.gear.host/>Polish blog</a></li><li><a href=/posts>Posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 minutes</p></div><article><h1 class=post-title><a href=/posts/binary-patching-tibia-multiclient/>Binary patching - creating Tibia MultiClient</a></h1><div class=post-content><div class=sect1><h2 id=_childhood_dreams>Childhood dreams</h2><div class=sectionbody><div class=paragraph><p>During some of my first school years I used to play an MMORPG game.
It had a reputation for having a lot of cheats for it.
(Bad reputation still counts as reputation, right?)</p></div><div class=paragraph><p>People have created all kinds of software for it.
Some small and harmless programs enabled you to change the outfit of your character client-side.
Others, much clever ones, made trees invisible, so you could see items hidden behind them.
The most advanced ones (called <code>bots</code>) could play the whole game for you.</p></div><div class=paragraph><p>Despite wide range of cheats, people had hard time choosing.
You either had to pay a significant amount of money to buy cheats from a reliable party or
download some sketchy <code>.exe</code> file and put your account at risk.
Both options stood far from ideal.</p></div><div class=paragraph><p>I remember I dreamed about having all the necessary skills to create such cheats all by myself.
A lot of time had passed since this dreaming, will I live up to my past self’s expectations?</p></div></div></div><div class=sect1><h2 id=_multiclient>MultiClient</h2><div class=sectionbody><div class=paragraph><p>Let’s start with creating something simple.
Let’s start with the <code>MultiClient</code>.</p></div><div class=paragraph><p>What is a <code>MultiClient</code>?
Well.
Unmodified game client allows you to have only one instance of it running.
All subsequent clients will display an error message and then shut down.</p></div><div class=imageblock><div class=content><img src=https://i.ibb.co/4sMQBqK/ss.png alt=ss width=100%></div></div><div class=paragraph><p>A <code>MultiClient</code> just allows running multiple instances of the game client.</p></div></div></div><div class=sect1><h2 id=_legal>Legal</h2><div class=sectionbody><div class=paragraph><p>I do consider creating cheats to online games as unethical, I really do.
Why I write about creating such a cheat then?
In my defence, I will write about an old version of the game (<code>9.44</code>).
Current version (<code>11</code>) uses anti-cheat mechanism called <code>BattlEye</code>, and the described
technique does not work in it anymore.</p></div></div></div><div class=sect1><h2 id=_naive_attempt_without_debugger>Naive attempt without debugger</h2><div class=sectionbody><div class=paragraph><p>At first, I thought I could achieve my goal without running the application.
I wanted to use some decompiler, then patch it and then run it.</p></div><div class=paragraph><p>I searched for the string from the error message and found only one Cross Reference to it.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/hW8qHA0.png alt=hW8qHA0 width=100%></div></div><div class=paragraph><p>Following the Cross Reference I found a big <code>switch</code> statement, which probably handles all the errors.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/CaqZHdG.png alt=CaqZHdG width=100%></div></div><div class=paragraph><p>I zoomed in to see the error message I searched for.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/vJTrry4.png alt=vJTrry4 width=100%></div></div><div class=paragraph><p>Let’s backtrack from here and investigate how the <code>switch</code> value might end as <code>0x1c</code>.
Execution jumps to different cases based on <code>eax</code> value.
This value basically equals to <code>arg3</code> value, decreased by 1.
To find out the value provided as <code>arg3</code> we need to find Cross References of <code>print_error_message</code> function.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/74LmIJj.png alt=74LmIJj width=100%></div></div><div class=paragraph><p>Caller of <code>print_error_message</code> provides its <code>arg2</code> as the third argument.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/Ur1iVN9.png alt=Ur1iVN9 width=100%></div></div><div class=paragraph><p>The caller function has 5 references to it.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/UaaSNCy.png alt=UaaSNCy width=100%></div></div><div class=paragraph><p>I checked all of them and none made any sense to me, so I gave up with not using a debugger.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/8jsr7mN.png alt=8jsr7mN width=100%></div></div><div class=imageblock><div class=content><img src=https://i.imgur.com/9pR7DVk.png alt=9pR7DVk width=100%></div></div><div class=imageblock><div class=content><img src=https://i.imgur.com/9pR7DVk.png alt=9pR7DVk width=100%></div></div><div class=imageblock><div class=content><img src=https://i.imgur.com/BtL2rKN.png alt=BtL2rKN width=100%></div></div><div class=imageblock><div class=content><img src=https://i.imgur.com/vphgD7u.png alt=vphgD7u width=100%></div></div></div></div><div class=sect1><h2 id=_debugging_strategy>Debugging strategy</h2><div class=sectionbody><div class=paragraph><p>For debugging I used <code>x64dbg</code> on Windows 10.</p></div><div class=paragraph><p>I searched for the same string from the error message.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/IaQDs1f.png alt=IaQDs1f width=100%></div></div><div class=paragraph><p>I set a breakpoint at this address and hit it after opening the second client.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/kQpQCLY.png alt=kQpQCLY width=100%></div></div><div class=paragraph><p>Having Instruction Pointer set on <code>00302E41</code> address I set breakpoints on each address of the call stack.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/JcSjLFG.png alt=JcSjLFG width=100%></div></div><div class=paragraph><p>I restarted the client and started looking through the code at each breakpoint.
It took a couple of minutes when I came across a call to <code>CreateMutexA</code> function.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/nd5rmyE.png alt=nd5rmyE width=100%></div></div></div></div><div class=sect1><h2 id=_mutex_explanation>Mutex explanation</h2><div class=sectionbody><div class=paragraph><p>I studied <code>WinAPI</code> documentation
<a href=https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-createmutexa>page</a>
to get more information about this function.</p></div><div class=quoteblock><blockquote><div class=paragraph><p>Creates or opens a named or unnamed mutex object.</p></div></blockquote><div class=attribution>— Description</div></div><div class=quoteblock><blockquote><div class=paragraph><p>If the function succeeds, the return value is a handle to the newly created mutex object.</p></div><div class=paragraph><p>If the function fails, the return value is NULL. To get extended error information, call GetLastError.</p></div><div class=paragraph><p>If the mutex is a named mutex and the object existed before this function call, the return value is a handle to the existing object, and the GetLastError function returns ERROR_ALREADY_EXISTS.</p></div></blockquote><div class=attribution>— Return value</div></div><div class=quoteblock><blockquote><div class=paragraph><p>If you are using a named mutex to limit your application to a single instance, a malicious user can create this mutex before you do and prevent your application from starting. To prevent this situation, create a randomly named mutex and store the name so that it can only be obtained by an authorized user. Alternatively, you can use a file for this purpose. To limit your application to one instance per user, create a locked file in the user’s profile directory.</p></div></blockquote><div class=attribution>— Remarks</div></div><div class=paragraph><p>Aha!
So the application uses this <code>WinAPI</code> function to limit execution to a single instance.</p></div><div class=paragraph><p>If a second instance tries to create a second mutex <code>GetLastError</code> will return some error.</p></div><div class=paragraph><p>Now I only need to patch the application so that it does not call <code>GetLastError</code>.</p></div></div></div><div class=sect1><h2 id=_patching>Patching</h2><div class=sectionbody><div class=paragraph><p>I assume this <code>B7</code> value means <code>ERROR_ALREADY_EXISTS</code> so I’d rather not execute the jump from line below the comparison.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/DptkRUs.png alt=DptkRUs width=100%></div></div><div class=paragraph><p>To remove this jump I right clicked on this line and chose <code>Assemble</code>.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/dtjkoK2.png alt=dtjkoK2 width=100%></div></div><div class=paragraph><p>I replaced this <code>je</code> instruction with <code>nop</code> instruction, which does nothing.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/PcqUTbJ.png alt=PcqUTbJ width=100%></div></div><div class=imageblock><div class=content><img src=https://i.imgur.com/90bByA3.png alt=90bByA3 width=100%></div></div><div class=imageblock><div class=content><img src=https://i.imgur.com/2PvnAYw.png alt=2PvnAYw width=100%></div></div><div class=paragraph><p>Unfortunately when I tried to use patching functionality of <code>x64dbg</code> it crashed every time.
I had to patch in kind of manual way, using some hex editor.</p></div><div class=paragraph><p>Firstly I remembered a fragment of the hex dump, which I needed to patch.
I highlighted the two bytes, which <code>x64dbg</code> changed to <code>90</code>.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/UCF8PoT.png alt=UCF8PoT width=100%></div></div><div class=paragraph><p>Having in mind the previous values, let’s find them in the hex editor.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/QQPdvyg.png alt=QQPdvyg width=100%></div></div><div class=paragraph><p>I used <code>HxD</code> to find and replace those two bytes.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/WfMq2OX.png alt=WfMq2OX width=100%></div></div></div></div><div class=sect1><h2 id=_result>Result</h2><div class=sectionbody><div class=paragraph><p>I saved the patched <code>.exe</code> file and tried running more than one client with great success.</p></div><div class=imageblock><div class=content><img src=https://i.imgur.com/y5NsUUq.png alt=y5NsUUq width=100%></div></div></div></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=/tags/re>re</a></span><span class=tag><a href=/tags/patching>patching</a></span><span class=tag><a href=/tags/binary>binary</a></span><span class=tag><a href=/tags/reverse-engineering>reverse-engineering</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>873 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-11-23 00:00 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/hacking-buttons-p2/><span class=button__icon>←</span>
<span class=button__text>Hacking buttons - part 2</span></a></span>
<span class="button next"><a href=/posts/first-3d-printout/><span class=button__text>First 3D Printout</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//matishadow-blog.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span></span><span><a href=/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.766584e6ea536f54faf86b018d73f719fc520199a6c4d32cbd959eb87634c11b380ac646d80d67304313aac0f5f05e6715221bd99a619bbc905365b55f78147f.js integrity="sha512-dmWE5upTb1T6+GsBjXP3GfxSAZmmxNMsvZWeuHY0wRs4CsZG2A1nMEMTqsD18F5nFSIb2Zphm7yQU2W1X3gUfw=="></script></body></html>